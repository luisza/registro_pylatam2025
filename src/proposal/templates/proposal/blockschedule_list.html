{% extends 'base.html' %}
{% load i18n %}
{% load bootstrap %}
{% load registro_charla %}
{% load static %}
{% block css %}
    <link href="{% static 'css/proposal.css' %}" rel="stylesheet">
{% endblock %}
{% block content %}
    <h2> Temáticas </h2>

    <form id="activityForm" name="activityForm" method="post" hidden>
        {% csrf_token %}
        <label>Inicio</label>
        {{ form.start_time }}
        <label>Fin</label>
        {{ form.end_time }}
        <label>Speech</label>
        {{ form.speech }}
        <label>Room</label>
        {{ form.room }}
        <label>Is_peech</label>
        {{ form.is_speech }}
        <label>Text</label>
        {{ form.text }}
        <label>Color</label>
        {{ form.color }}
        <input name="form_id" value="activityForm">
        <input type="submit" name="action" value={% trans 'Submit' %}>
    </form>

    <div class="row">
        <div class="col-sm-3">
            <h4> {% trans 'Speeches' %} </h4>
            <hr>
            <div class="card">
                <div class="card-body">
                    <div class="inline-flex">
                        <div class="input-group">
                            <span class="input-group-btn">
                                <a data-toggle="modal"
                                   data-target="#topic-modal" class="btn btn-success add-button"><i
                                        class="fas fa-plus"></i></a>
                            </span>
                            <form id="filter" method="post">
                                {% csrf_token %}
                                <select class="btn sidebar-select btn-primary" name="topic"
                                        id="topic">
                                    <option selected value="None">Topic</option>
                                    {% for topic in topics %}
                                        <option value={{ topic.id }}>{{ topic }}</option>
                                    {% endfor %}
                                </select>
                        </div>
                        <div class="input-group">
                            <span class="input-group-btn">
                                <a data-toggle="modal" data-target="#type-modal"
                                   class="btn btn-success add-button">
                                    <i class="fas fa-plus"></i></a>
                            </span>
                            <select class="btn sidebar-select btn-primary" name="type"
                                    id="type">
                                <option selected value="None">Type</option>
                                {% for type in types %}
                                    <option value={{ type.id }}>{{ type }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <a onclick="send_filter()" id="search" class="btn btn-info add-button"><i
                                class="fas fa-search"></i></a>
                        </form>
                    </div>
                </div>
            </div>
            <div class="jumbotron">
                <ul id="speeches" class="connectedSortable">
                    {% for speech in speeches %}
                        <li class="ui-state-default activity" style="background-color: {{ speech.topic.color }};"
                            value="{{ speech.pk }}" color="{{ speech.topic.color }}"
                            time="{{ speech.time_given.time }}" is_speech="1" desc="none">{{ speech }}</li>
                    {% endfor %}
                </ul>
            </div>
            <br>
            <div class="inline-flex">
                <h2> {% trans 'Special Activities' %}</h2>
                <div class="add-activity">
                    <a data-toggle="modal" data-target="#special-modal"
                       class="btn btn-success add-button pl-2"><i class="fas fa-plus"></i></a>
                </div>
            </div>
            <hr>
            <div class="jumbotron">
                <ul id="specials" class="connectedSortable">
                    {% for special in specialActivity %}
                        <li class="ui-state-default activity" style="background-color: #ddd234;" color="#ddd234"
                            time="{{ special.time.time }}" is_speech="0"
                            desc="{{ special.message }}"
                            value="{{ special.pk }}">
                            {{ special }}
                        </li>
                    {% endfor %}
                </ul>
            </div>

            <div id="topic-modal" class="modal fade" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title"> {% trans 'New Speech Topic' %} </h4>
                        </div>
                        <div class="modal-body" style="text-align: center">
                            <form action="proposal/createTopic/" method="post">
                                {% csrf_token %}
                                <div class="jumbotron" style="display: inline-grid">
                                    {{ topicForm }}
                                    <hr>
                                    <input class="btn btn-info" type="submit" value="{% trans 'Save' %}">
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div id="type-modal" class="modal fade" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title"> {% trans 'New Speech Type' %}</h4>
                        </div>
                        <div class="modal-body" style="text-align: center">
                            <form action="proposal/createType/" method="post">
                                {% csrf_token %}
                                <div class="jumbotron" style="display: inline-grid">
                                    {{ typeForm }}
                                    <hr>
                                    <input class="btn btn-info" type="submit" value="{% trans 'Save' %}">
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div id="special-modal" class="modal fade" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">{% trans 'New Special Activity' %}</h4>
                        </div>
                        <div class="modal-body" style="text-align: center">
                            <form action="proposal/createSpecial/" method="post">
                                {% csrf_token %}
                                <div class="jumbotron" style="display: inline-grid;">
                                    {{ specialForm }}
                                    <hr>
                                    <input class="btn btn-info" type="submit" value="{% trans 'Save' %}">
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-9">
            <div class="container">
                <ul class="days nav nav-tabs">
                    {% for d in dayList %}
                        <li role="presentation" class="{% if dia ==  forloop.counter %} active {% endif %}">
                            <a href="{% url 'list_charlas' %}?dia={{ forloop.counter }}">{{ d }}</a>
                        </li>
                    {% endfor %}
                </ul>
                <div class="roomContainer">
                    <ul class="nav nav-tabs flex-column">
                        {% for room in rooms_list %}
                            <li role="presentation" class="{% if sala == forloop.counter %} active {% endif %}">
                                <a href="{% url 'list_charlas' %}?dia={{ dia }}&sala={{ forloop.counter }}">{{ room }}</a>
                            </li>
                        {% endfor %}
                        <li role="presentation" class="">
                            <a href="#" data-toggle="modal" data-target="#room_modal">{% trans 'Add' %}</a>
                        </li>
                    </ul>
                </div>
                <div class="scheduleContainer">
                    <button id="send_activities" name="send_activities"
                            onclick="send_activities_list()">{% trans 'Submit' %}</button>
                    <table class="table">
                        <thead class="thead">
                        <tr>
                            <th>Horario</th>
                            <th>Actividad</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td class="horaCalendario">7:00</td>
                            <td class="" hora="7:00:00">
                                <ul id="hour-7" hora="7:00:00" class="connectedSortable droppable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">8:00</td>
                            <td class="droppable" hora="8:00:00">
                                <ul id="hour-8"   hora="8:00:00" class="connectedSortable droppable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">9:00</td>
                            <td class="droppable" hora="9:00:00">
                                <ul id="hour-9"  hora="9:00:00" class="connectedSortable droppable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">10:00</td>
                            <td class="droppable" hora="10:00:00">
                                <ul id="hour-10"  hora="10:00:00" class="connectedSortable droppable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">11:00</td>
                            <td class="droppable" hora="11:00:00">
                                <ul id="hour-11"  hora="11:00:00" class="connectedSortable droppable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">12:00</td>
                            <td class="droppable" hora="12:00:00">
                                <ul id="hour-12"  hora="12:00:00" class="connectedSortable droppable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">13:00</td>
                            <td class="droppable" hora="13:00:00">
                                <ul id="hour-13" class="connectedSortable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">14:00</td>
                            <td class="droppable" hora="14:00:00">
                                <ul id="hour-14" class="connectedSortable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">15:00</td>
                            <td class="droppable" hora="15:00:00">
                                <ul id="hour-15" class="connectedSortable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">16:00</td>
                            <td class="droppable" hora="16:00:00">
                                <ul id="hour-16" class="connectedSortable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">17:00</td>
                            <td class="droppable" hora="17:00:00">
                                <ul id="hour-17" class="connectedSortable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">18:00</td>
                            <td class="droppable" hora="18:00:00">
                                <ul id="hour-18" class="connectedSortable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">19:00</td>
                            <td class="droppable" hora="19:00:00">
                                <ul id="hour-19" class="connectedSortable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">20:00</td>
                            <td class="droppable" hora="20:00:00">
                                <ul id="hour-20" class="connectedSortable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">21:00</td>
                            <td class="droppable" hora="21:00:00">
                                <ul id="hour-21" class="connectedSortable"></ul>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <hr>
    <div class="container">
        <div class="scheduleContainer">
            <div class="row theader">
                <div class="col-md-2">Horario</div>
                <div class="col-md-5">Título</div>
                <div class="col-md-2">Expositor/a responsable</div>
                <div class="col-md-1">Salón</div>
                <div class="col-md-2">Registro</div>
            </div>
        </div>

        {% for obj in object_list %}

            <div id="block_{{ obj.pk }}" class="row {% if obj.is_speech %}speech_row{% else %} text_row {% endif %}"
                 style="background-color:{{ obj.color }}">

                {% if obj.is_speech and obj.room.name == room_name %}
                    {% for speech in obj.get_speech %}
                        {% if speech.room.name == room_name %}
                            <div class="row">
                                <div class="col-md-2">{{ speech.start_time | date:"P" }}
                                    a {{ speech.end_time | date:"P" }}
                                    <p style="color:{{ speech.speech.topic.color }}">
                                        {{ speech.speech.speech_type.name }}
                                    </p>
                                    {{ speech.registros }}

                                </div>
                                <div class="col-md-5">

                                    <a href="{% url 'detail_charla' speech.speech.pk %}"
                                       target="_blank"> {{ speech.speech.title }} </a>
                                </div>
                                <div class="col-md-2">{{ speech.speech.user.get_full_name }}</div>
                                <div class="col-md-1">{{ speech.room.name }}</div>
                                <div class="col-md-2" style="display: flex">  {% get_registro speech as nreg %} <a
                                        href="{{ nreg.url }}"> {{ nreg.message }} </a>
                                    <form method="post" style="margin-left: 10%">
                                        {% csrf_token %}
                                        <input name="form_id" value="delete" hidden>
                                        <input name='block' value="{{ obj.pk }}" hidden>
                                        <input name='room' value="{{ room_id }}" hidden>
                                        <input type="submit" value="x" class="btn btn-danger btn-sm">
                                    </form>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}

                {% else %}
                    {% if obj.room.name == room_name %}
                        <div class="col-md-2 text-center"> {{ obj.start_time | date:"P" }}
                            a {{ obj.end_time | date:"P" }} </div>
                        <div class="col-md-10 text-center"> {{ obj.text }}
                            <form method="post" style="float:right">
                                {% csrf_token %}
                                <input name="form_id" value="delete" hidden>
                                <input name='block' value="{{ obj.pk }}" hidden>
                                <input name='room' value="{{ room_id }}" hidden>
                                <input type="submit" value="x" class="btn btn-danger btn-sm">
                            </form>
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        {% endfor %}
    </div>

    <br><br>

    <p id="actualDay" hidden>{{ diaActual.year }}-{{ diaActual.month }}-{{ diaActual.day }}</p>
    <p id="actualRoom" hidden>{{ room_id }}</p>
    <br><br>

    <div class="modal fade" role="dialog" id="room_modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h2 class="modal-title text-center">{% trans 'Create Room' %}</h2>
                </div>
                <div class="modal-body">
                    <form name="roomForm" action="proposal/createRoom/" method="post">
                        {% csrf_token %}
                        {{ room_form|bootstrap }}
                        <input name="form_id" value="roomForm" hidden>
                        <br>
                        <div class="form-group text-center">
                            <input type="submit" name="action" class="btn btn-primary" value="{% trans 'Save Room' %}">
                            <button type="button" class="btn btn-secondary"
                                    data-dismiss="modal">{% trans 'Close' %}</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


{% endblock %}

{% block js %}
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
        var lista = [];

        $(function () {
            $("#speeches, #specials, #hour-7, #hour-8, #hour-9,#hour-10, #hour-11, #hour-12,#hour-13, #hour-14,#hour-15, #hour-16, #hour-17, #hour-18, #hour-19, #hour-20, #hour-21").sortable({
                placeholder: "ui-state-highlight",
                connectWith: ".connectedSortable",
            }).disableSelection();
        });

        $(function () {
            $(".droppable").droppable({
                drop: function (event, ui) {
                    ui.draggable.attr('start_time', $("#actualDay").text() + " " + $(this).attr("hora"))
                    ui.draggable.attr('end_time', addhoras($(this).attr("hora"), ui.draggable.attr("time")))
                    ui.draggable.attr('room', $("#actualRoom").text())

                    $("#id_speech").val(ui.draggable.val());
                    $("#id_start_time").val($("#actualDay").text() + " " + $(this).attr("hora"));
                    $("#id_end_time").val(addhoras($(this).attr("hora"), ui.draggable.attr("time")));
                    $("#id_color").val((ui.draggable.attr("color")));
                    var is_speech = null
                    if (ui.draggable.attr("is_speech") == 1) {
                        $("#id_is_speech").prop("checked", true);
                        is_speech = true
                    } else {
                        $("#id_is_speech").prop("checked", false);
                        is_speech = ""
                    }
                    $("#id_room").val($("#actualRoom").text());
                    $("#id_text").val(ui.draggable.attr("desc"));
                    var element = {
                        'pk_speech': ui.draggable.val(),
                        'color': ui.draggable.attr("color"),
                        'start_time': ui.draggable.attr('start_time'),
                        'end_time': ui.draggable.attr('end_time'),
                        'is_speech': is_speech,
                        'room': ui.draggable.attr('room'),
                        'description': ui.draggable.attr("desc"),
                    }


                    var value = activities_in_list(element)
                    if (value == false) {
                        lista.push(element)
                    }
                }
            });
        });


        function activities_in_list(element) {
            value = false
            for (var i = 0; i < lista.length; i++) {
                if (lista[i]['is_speech'] === element['is_speech']) {
                    if (lista[i]['pk_speech'] === element['pk_speech']) {
                        lista.splice(i, 1)
                        lista.push(element)
                        value = true
                    }
                }
            }
            return value
        }

        function send_activities_list() {
            var token = '{{csrf_token}}';
            $.ajax({
                headers: {"X-CSRFToken": token},
                type: "post",
                data: {
                    'agenda': JSON.stringify(lista),
                },
                success: function (data) {
                    console.log(data)
                    location.reload()
                }
            });

        }

        function addhoras(hora, minutos) {
            starttime = new Date($("#actualDay").text() + " " + hora)
            starttime.setMinutes(starttime.getMinutes() + minutos)
            endtime = $("#actualDay").text() + " " + starttime.getHours() + ":" + starttime.getMinutes() + ":00"
            return (endtime)
        }

        function send_filter() {
            $('#speeches').empty()
            $.ajax({
                url: "proposal/filterSpeeches/",
                type: "post",
                data: $("#filter").serialize(),
                success: function (data) {
                    if (data.result.length != 0) {
                        result = JSON.parse(data.result)
                        if (Object.entries(result).length == 0) {
                            result = null
                        }
                    } else {
                        result = null
                    }
                    if (result != null) {
                        for (var i = 0; i < result.length; i++)
                            $('#speeches').append('<li class="draggable activity" style="background-color:' + data.color[i] + ';"' +
                                'value=' + Object.values(result[i])[1] + ' color=' + data.color[i] +
                                ' is_speech="1"' + 'desc="none"' + 'time=' + data.times[i] + '>' +
                                Object.values(result[i]['fields'])[2] + '</li>')
                        $('.draggable').draggable();
                    } else {
                        $('#speeches').append('<p>No results matched</p>')
                    }
                }
            });
        }
    </script>
{% endblock %}