{% extends 'base.html' %}
{% load i18n %}
{% load bootstrap %}
{% load registro_charla %}
{% load static %}
{% block css %}
    <link href="{% static 'css/proposal.css' %}" rel="stylesheet">
{% endblock %}
{% block content %}
    <h2> Tem√°ticas </h2>

    <form id="activityForm" name="activityForm" method="post" hidden>
        {% csrf_token %}
        <label>Inicio</label>
        {{ form.start_time }}
        <label>Fin</label>
        {{ form.end_time }}
        <label>Speech</label>
        {{ form.speech }}
        <label>Room</label>
        {{ form.room }}
        <label>Is_peech</label>
        {{ form.is_speech }}
        <label>Text</label>
        {{ form.text }}
        <label>Color</label>
        {{ form.color }}
        <input name="form_id" value="activityForm">
        <input type="submit" name="action" value={% trans 'Submit' %}>
    </form>

    <div class="row">
        <div class="col-sm-5" id="filterPanel">
            <h4> {% trans 'Speeches' %} </h4>
            <hr>
            <div class="card">
                <div class="card-body">
                    <div class="row flex">
                        <div class="col-md-6 inline-flex">
                            <div class="col-2">
                                <span class="input-group-btn">
                                    <a style="height: 40px;" data-toggle="modal"
                                       data-target="#topic-modal" class="btn btn-success add-button">
                                        <i class="fas fa-plus" style="margin-top: 15px"></i>
                                    </a>
                                </span>
                            </div>
                            <div class="col-10">
                                <form id="filter" method="post">
                                    {% csrf_token %}
                                    <select class="btn sidebar-select btn-primary" style="height: 40px" name="topic"
                                            id="topic">
                                        <option selected value="None">{% trans 'Topic' %}</option>
                                        {% for topic in topics %}
                                            <option value={{ topic.id }}>{{ topic }}</option>
                                        {% endfor %}
                                    </select>
                            </div>
                        </div>
                        <div class="col-md-6 inline-flex">
                            <div class="col-2">
                                <span class="input-group-btn">
                                    <a style="height: 40px" data-toggle="modal" data-target="#type-modal"
                                       class="btn btn-success add-button">
                                        <i style="margin-top: 15px" class="fas fa-plus"></i></a>
                                </span>
                            </div>
                            <div class="col-9">
                                <select class="btn sidebar-select btn-primary" style="height: 40px" name="type" id="type">
                                    <option selected value="None">{% trans 'Type' %}</option>
                                    {% for type in types %}
                                        <option value={{ type.id }}>{{ type }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-1">
                                <a style="height: 40px" onclick="send_filter()" id="search" class="btn btn-info add-button">
                                    <i style="margin-top: 15px" class="fas fa-search"></i>
                                </a>
                                </form>
                            </div>
                        </div>
                    </div>
                    <br>
                    <div class="jumbotron">
                        <ul id="speeches" class="connectedSortable droppable" hora="7:00:00">
                            {% for speech in speeches %}


                                <li class="ui-state-default activity" style="background-color: {{ speech.topic.color }};"
                                    value="{{ speech.pk }}" color="{{ speech.topic.color }}"
                                    time="{{ speech.speech_type.time }}" is_speech="1" desc="none">
                                    <div class="row">
                                        <div class="col-sm-8">
                                            {{ speech }}
                                        </div>
                                        <div class="col-sm-4">
                                            <select class="">time
                                                <option selected value="None">Type</option>
                                                <option selected value="None">Type</option>
                                                <option selected value="None">Type</option>
                                            </select>
                                        </div>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                    <br>
                    <div class="inline-flex">
                        <h4> {% trans 'Special Activities' %}</h4>
                        <div class="add-activity">
                            <a data-toggle="modal" data-target="#special-modal"
                               class="btn btn-success add-button pl-2"><i class="fas fa-plus"></i></a>
                        </div>
                    </div>
                    <hr>
                    <div class="jumbotron">
                        <ul id="specials" class="connectedSortable droppable" hora="7:00:00">
                            {% for special in specialActivity %}
                                <li class="ui-state-default activity" style="background-color: #ddd234;" color="#ddd234"
                                    time="{{ special.type.time }}" is_speech="0"
                                    desc="{{ special.message }}"
                                    value="{{ special.pk }}">
                                    {{ special }}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>

                    <div id="topic-modal" class="modal fade" role="dialog">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                    <h4 class="modal-title"> {% trans 'New Speech Topic' %} </h4>
                                </div>
                                <div class="modal-body" style="text-align: center">
                                    <form action="proposal/createTopic/" method="post">
                                        {% csrf_token %}
                                        <div class="jumbotron" style="display: inline-grid">
                                            {{ topicForm }}
                                            <hr>
                                            <input class="btn btn-info" type="submit" value="{% trans 'Save' %}">
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="type-modal" class="modal fade" role="dialog">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                    <h4 class="modal-title"> {% trans 'New Speech Type' %}</h4>
                                </div>
                                <div class="modal-body" style="text-align: center">
                                    <form action="proposal/createType/" method="post">
                                        {% csrf_token %}
                                        <div class="jumbotron" style="display: inline-grid">
                                            {{ typeForm }}
                                            <hr>
                                            <input class="btn btn-info" type="submit" value="{% trans 'Save' %}">
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="special-modal" class="modal fade" role="dialog">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                    <h4 class="modal-title">{% trans 'New Special Activity' %}</h4>
                                </div>
                                <div class="modal-body" style="text-align: center">
                                    <form action="proposal/createSpecial/" method="post">
                                        {% csrf_token %}
                                        <div class="jumbotron" style="display: inline-grid;">
                                            {{ specialForm }}
                                            <hr>
                                            <input class="btn btn-info" type="submit" value="{% trans 'Save' %}">
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-7">
            <div class="container">
                <ul class="days nav nav-tabs">
                    {% for d in dayList %}
                        <li role="presentation" class="{% if dia ==  forloop.counter %} active {% endif %}">
                            <a href="{% url 'edit_charlas' %}?dia={{ forloop.counter }}">{{ d }}</a>
                        </li>
                    {% endfor %}
                </ul>
                <div class="roomContainer">
                    <ul class="nav nav-tabs flex-column">
                        {% for room in rooms_list %}
                            <li role="presentation" class="{% if sala == forloop.counter %} active {% endif %}">
                                <a href="{% url 'edit_charlas' %}?dia={{ dia }}&sala={{ forloop.counter }}">{{ room }}</a>
                            </li>
                        {% endfor %}
                        <li role="presentation" class="">
                            <a id="addroom" href="#" data-toggle="modal" data-target="#room_modal">{% trans 'Add' %}</a>
                        </li>
                    </ul>
                </div>
                <div class="scheduleContainer">
                    <button id="send_activities" name="send_activities"
                            onclick="send_activities_list()">{% trans 'Submit' %}</button>
                    <table class="table">
                        <thead class="thead">
                        <tr>
                            <th>Horario</th>
                            <th>Actividad</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td class="horaCalendario">7:00</td>
                            <td class="droppable" hora="7:00:00" id="td-7" lasthour="7:00:00">
                                <ul id="hour-7" hora="7:00:00" class="connectedSortable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">8:00</td>
                            <td class="droppable" hora="8:00:00" id="td-8" lasthour="8:00:00">
                                <ul id="hour-8" hora="8:00:00" class="connectedSortable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">9:00</td>
                            <td class="droppable" hora="9:00:00" id="td-9" lasthour="9:00:00">
                                <ul id="hour-9" hora="9:00:00" class="connectedSortable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">10:00</td>
                            <td class="droppable" hora="10:00:00" id="td-10" lasthour="10:00:00">
                                <ul id="hour-10" hora="10:00:00" class="connectedSortable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">11:00</td>
                            <td class="droppable" hora="11:00:00" id="td-11" lasthour="11:00:00">
                                <ul id="hour-11" hora="11:00:00" class="connectedSortable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">12:00</td>
                            <td class="droppable" hora="12:00:00" id="td-12" lasthour="12:00:00">
                                <ul id="hour-12" hora="12:00:00" class="connectedSortable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">13:00</td>
                            <td class="droppable" hora="13:00:00" id="td-13" lasthour="13:00:00">
                                <ul id="hour-13" class="connectedSortable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">14:00</td>
                            <td class="droppable" hora="14:00:00" id="td-14" lasthour="14:00:00">
                                <ul id="hour-14" class="connectedSortable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">15:00</td>
                            <td class="droppable" hora="15:00:00" id="td-15" lasthour="15:00:00">
                                <ul id="hour-15" class="connectedSortable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">16:00</td>
                            <td class="droppable" hora="16:00:00" id="td-16" lasthour="16:00:00">
                                <ul id="hour-16" class="connectedSortable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">17:00</td>
                            <td class="droppable" hora="17:00:00" id="td-17" lasthour="17:00:00">
                                <ul id="hour-17" class="connectedSortable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">18:00</td>
                            <td class="droppable" hora="18:00:00" id="td-18" lasthour="18:00:00">
                                <ul id="hour-18" class="connectedSortable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">19:00</td>
                            <td class="droppable" hora="19:00:00" id="td-19" lasthour="19:00:00">
                                <ul id="hour-19" class="connectedSortable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">20:00</td>
                            <td class="droppable" hora="20:00:00" id="td-20" lasthour="20:00:00">
                                <ul id="hour-20" class="connectedSortable"></ul>
                            </td>
                        </tr>
                        <tr>
                            <td class="horaCalendario">21:00</td>
                            <td class="droppable" hora="21:00:00" id="td-21" lasthour="21:00:00">
                                <ul id="hour-21" class="connectedSortable"></ul>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <hr>
    <div class="container">
        <div class="scheduleContainer">
            {% for obj in object_list %}
                {% if obj.is_speech and obj.room.name == room_name %}
                    {% for speech in obj.get_speech %}
                        {% if speech.room.name == room_name %}
                            <div class="speech_actvity"
                                 start_datetime="{{ speech.start_time | date:"Y-n-j G:i:s" }}"
                                 end_datetime="{{ speech.end_time | date:"Y-n-j G:i:s" }}"
                                 start_time="{{ speech.start_time | date:"G:i" }}"
                                 start_hour="{{ speech.start_time | date:"G" }}"
                                 end_time="{{ speech.end_time | date:"G:i" }}"
                                 color="{{ speech.speech.topic.color }}"
                                 name="{{ speech.speech.title }}"
                                 activity_pk="{{ speech.speech.pk }}"
                                 title="{{ speech.speech.title }}"
                                 room_name="{{ speech.room.name }}"
                                 room_pk="{{ speech.room.pk }}"
                                 obj_pk="{{ obj.pk }}"
                                 speech_pk="{{ speech.speech.pk }}"
                                 room_id="{{ room_id }}"
                                 is_speech="true"
                                 desc="none"
                                 time={{ speech.speech.speech_type.time }}
                            >
                            </div>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    {% if obj.room.name == room_name %}
                        {% for speech_schedule in obj.get_speech %}
                            <div class="special_actvity"
                                 start_datetime="{{ obj.start_time | date:"Y-n-j G:i:s" }}"
                                 end_datetime="{{ obj.end_time | date:"Y-n-j G:i:s" }}"
                                 start_time="{{ obj.start_time | date:"G:i" }}"
                                 start_hour="{{ obj.start_time | date:"G" }}"
                                 end_time="{{ obj.end_time | date:"G:i" }}"
                                 color="{{ '#858585' }}"
                                 time="{{ speech_schedule.special.type.time }}"
                                 desc="{{ obj.text }}"
                                 room_pk="{{ speech_schedule.room.pk }}"
                                 obj_pk="{{ obj.pk }}"
                                 value="{{ speech_schedule.special.pk }}"
                                 room_id="{{ room_id }}"
                                 is_speech=""
                            >
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <br><br>

    <p id="actualDay" hidden>{{ diaActual.year }}-{{ diaActual.month }}-{{ diaActual.day }}</p>
    <p id="actualRoom" hidden>{{ room_id }}</p>
    <br><br>

    <div class="modal fade" role="dialog" id="room_modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h2 class="modal-title text-center">{% trans 'Create Room' %}</h2>
                </div>
                <div class="modal-body">
                    <form name="roomForm" action="proposal/createRoom/" method="post">
                        {% csrf_token %}
                        {{ room_form|bootstrap }}
                        <input name="form_id" value="roomForm" hidden>
                        <br>
                        <div class="form-group text-center">
                            <input type="submit" name="action" class="btn btn-primary" value="{% trans 'Save Room' %}">
                            <button type="button" class="btn btn-secondary"
                                    data-dismiss="modal">{% trans 'Close' %}</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <form id="delete_activity" method="post" style="margin-left: 10%">
        {% csrf_token %}
        <input name="form_id" value="delete" hidden>
        <input name='block' id="obj_pk" value="{{ obj.pk }}" hidden>
        <input name='room' id="room_pk" value="{{ room_id }}" hidden>
    </form>

{% endblock %}

{% block js %}
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
        var lista = [];

        $(function () {
            $("#speeches, #specials, #hour-7, #hour-8, #hour-9,#hour-10, #hour-11, #hour-12,#hour-13, #hour-14,#hour-15, #hour-16, #hour-17, #hour-18, #hour-19, #hour-20, #hour-21").sortable({
                placeholder: "ui-state-highlight",
                connectWith: ".connectedSortable",
            }).disableSelection();
        });


        function difHours(hour1,hour2){
            starttime = new Date($("#actualDay").text() + " " + hour1)
            endime = new Date($("#actualDay").text() + " " + hour2)
            diff = endime-starttime
            return millisToMinutesAndSeconds(diff)
        }

        function millisToMinutesAndSeconds(millis) {
          var minutes = Math.floor(millis / 60000);
          var seconds = ((millis % 60000) / 1000).toFixed(0);
          return minutes + ":" + (seconds < 10 ? '0' : '') + seconds;
        }

        function update_last_hours(){
            for (var i = 7; i <= 20; ++i) {
                var minutes_left_to_assign = parseInt(difHours($('#td-' + (i+1) ).attr('hora'), $('#td-' + i).attr('lasthour')).split(":")[0])
                if( minutes_left_to_assign > 0 )
                {
                    $('#td-' + i ).attr('lasthour', addLastHour($('#td-' + i ).attr('hora'), 60));
                    $('#td-' + (i+1) ).attr('lasthour', addLastHour($('#td-' + (i+1)).attr('lasthour'), minutes_left_to_assign));
                }
            }
        }

        $(function () {
            $(".droppable").droppable({
                drop: function (event, ui) {

                    ui.draggable.attr('start_time', $("#actualDay").text() + " " + $(this).attr("lasthour"))
                    ui.draggable.attr('end_time', addhoras($(this).attr("lasthour"), ui.draggable.attr("time")))

                    hour = parseInt(ui.draggable.attr('start_hour'));

                    if($('#td-' + hour).attr('lasthour')){
                        if($('#td-' + hour).attr('hora') < substractLastHour($('#td-' + hour).attr('lasthour'),ui.draggable.attr("time"))){
                            $('#td-' + hour).attr('lasthour',substractLastHour($('#td-' + hour).attr('lasthour'),ui.draggable.attr("time")))
                        }
                    }
                    $(this).attr('lasthour',addLastHour($(this).attr('lasthour'), ui.draggable.attr("time")))
                    update_last_hours();



                    ui.draggable.attr('room', $("#actualRoom").text())
                    $("#id_speech").val(ui.draggable.val());
                    $("#id_start_time").val($("#actualDay").text() + " " + $(this).attr("lasthour"));
                    $("#id_end_time").val(addhoras($(this).attr("hora"), ui.draggable.attr("time")));
                    $("#id_color").val((ui.draggable.attr("color")));
                    var is_speech = null
                    if (ui.draggable.attr("is_speech") == 1 || ui.draggable.attr("is_speech") == 'true') {
                        $("#id_is_speech").prop("checked", true);
                        is_speech = 'true'
                    } else {
                        $("#id_is_speech").prop("checked", false);
                        is_speech = ""
                    }
                    $("#id_room").val($("#actualRoom").text());
                    $("#id_text").val(ui.draggable.attr("desc"));
                    var element = {
                        'pk_speech': ui.draggable.val(),
                        'color': ui.draggable.attr("color"),
                        'start_time': ui.draggable.attr('start_time'),
                        'end_time': ui.draggable.attr('end_time'),
                        'is_speech': is_speech,
                        'room': ui.draggable.attr('room'),
                        'description': ui.draggable.attr("desc"),
                    }

                    $('.'+ is_speech + ui.draggable.val()+'').remove();

                    ui.draggable.attr('start_hour', $(this).attr("hora").split(':')[0])


                    var s_time = ui.draggable.attr('start_time').split(" ")[1];
                    var e_time = ui.draggable.attr('end_time').split(" ")[1];
                    var times = parseInt(difHours(s_time, e_time).split(":")[0])/60;
                    var not_oclock = s_time.split(":")[1];
                    for (var j = 1; j < times; ++j) {
                        hour = parseInt(ui.draggable.attr('start_hour')) + j;
                        $('#hour-' + hour).append('<li class="activity ' + is_speech + ui.draggable.attr("value") + '" style="background-color:' + ui.draggable.attr("color") +'">' + '</li>');
                     }
                    if(not_oclock!=0)
                    {
                        $('#hour-' + (hour+1)).append('<li class="activity ' + is_speech + ui.draggable.attr("value") + '" style="background-color:' + ui.draggable.attr("color") +'">' + '</li>');
                    }

                    var value = activities_in_list(element)
                    if (value == false) {
                        lista.push(element)
                    }
                    if ($(this).attr('id') === 'speeches' || $(this).attr('id') === 'specials') {
                        delete_temp_activity(ui.draggable.attr('value'), ui.draggable.attr('is_speech'))
                        if (ui.draggable.attr('db')) {
                            delete_actity(ui.draggable.attr('room'), ui.draggable.attr('db'))
                        }
                    }
                }
            });
            update_last_hours();
        });


        $(function () {
            var special = document.getElementsByClassName("special_actvity")
            for (var i = 0; i < special.length; ++i) {
                $("#td-"+ special[i].getAttribute("start_hour")).attr('lasthour',addLastHour( $("#td-"+ special[i].getAttribute("start_hour")).attr('lasthour'),special[i].getAttribute("time")))
                $('#hour-' + special[i].getAttribute("start_hour")).append(
                    '<li class="ui-state-default activity" style="background-color: ' + special[i].getAttribute("color") + ';"' +
                    ' value="' + special[i].getAttribute("value") + '" color="' + special[i].getAttribute("color") + '"' +
                    ' is_speech= "" ' + ' desc="' + special[i].getAttribute("desc") + '"' +
                    ' time="' + special[i].getAttribute("time") + '"' + ' start_hour= "' + special[i].getAttribute("start_hour") + '" ' +
                    'db="' + special[i].getAttribute("obj_pk") + ' "start_time="' + special[i].getAttribute("start_time") +
                    '">' +
                    '<div class="row">' +
                    '<div class="col-md-2 text-center">' +
                    special[i].getAttribute("start_time") + ' a ' + special[i].getAttribute("end_time") +
                    '</div>' +
                    '<div class="col-md-9 text-center">' +
                    special[i].getAttribute("desc") +
                    '</div>' +
                    '<div class="col-md-1 text-center">' +
                    '<button onclick="delete_actity(' + special[i].getAttribute("room_pk") + ', ' + special[i].getAttribute("obj_pk") + ')" class="btn btn-danger btn-sm deleteButton"> X </button>' +
                    '</div>' +
                    '</div>' +
                    '</li>'
                );
                var s_time = special[i].getAttribute('start_datetime').split(" ")[1];
                var e_time = special[i].getAttribute('end_datetime').split(" ")[1];
                var times = parseInt(difHours(s_time, e_time).split(":")[0])/60;
                var not_oclock = s_time.split(":")[1];
                var hour=0;
                for (var j = 1; j < times ; ++j) {
                    hour = parseInt(special[i].getAttribute("start_hour")) + j;
                    $('#hour-' + hour).append('<li class="activity ' + special[i].getAttribute("value") + '" style="background-color:' + special[i].getAttribute("color") +'">' + '</li>');
                }
                if(not_oclock!=0)
                {
                    $('#hour-' + (hour+1)).append('<li class="activity ' + special[i].getAttribute("value") + '" style="background-color:' + special[i].getAttribute("color") +'">' + '</li>');
                }

                var element = {
                    'pk_speech': special[i].getAttribute("value"),
                    'color': special[i].getAttribute("color"),
                    'start_time': special[i].getAttribute("start_datetime"),
                    'end_time': special[i].getAttribute("end_datetime"),
                    'is_speech': special[i].getAttribute("is_speech"),
                    'room': special[i].getAttribute("room_pk"),
                    'description': special[i].getAttribute("desc"),
                }
                lista.push(element)
            }
            update_last_hours();
        });

        $(function () {
            var blocks = document.getElementsByClassName("speech_actvity")

            var url_mask = "{% url 'detail_charla' pk=0 %}";

            for (var i = 0; i < blocks.length; ++i) {
                $("#td-"+ blocks[i].getAttribute("start_hour")).attr('lasthour',addLastHour( $("#td-"+ blocks[i].getAttribute("start_hour")).attr('lasthour'),blocks[i].getAttribute("time")))
                $('#hour-' + blocks[i].getAttribute("start_hour")).append(
                    '<li class="ui-state-default activity" style="background-color: ' + blocks[i].getAttribute("color") + ';"' +
                    ' value="' + blocks[i].getAttribute("activity_pk") + '"' + ' color="' + blocks[i].getAttribute("color") + '"' +
                    ' is_speech="' + blocks[i].getAttribute("is_speech") + '"' + ' desc="' + blocks[i].getAttribute("desc") + '"' +
                    ' time="' + blocks[i].getAttribute("time") + '"' + ' start_hour= "' + blocks[i].getAttribute("start_hour") + '"' +
                    'db="' + blocks[i].getAttribute("obj_pk") + ' "start_time="' + blocks[i].getAttribute("start_time") +
                    '">' +
                    '<div class="row">' +
                    '<div class="col-md-2 text-center">' +
                    blocks[i].getAttribute("start_time") + ' a ' + blocks[i].getAttribute("end_time") +
                    '</div>' +
                    '<div class="col-md-9 text-center">' +
                    '<a style="margin-left: 7%;" href=' + url_mask.replace(/0/, blocks[i].getAttribute("speech_pk")) + '>' +
                    blocks[i].getAttribute("name") +
                    '</a>' +
                    '</div>' +
                    '<div class="col-md-1 text-center">' +
                    '<button onclick="delete_actity(' + blocks[i].getAttribute("room_pk") + ', ' + blocks[i].getAttribute("obj_pk") + ')" class="btn btn-danger btn-sm deleteButton"> X </button>' +
                    '</div>' +
                    '</div>' +
                    '</li>'
                );


                var s_time = blocks[i].getAttribute('start_datetime').split(" ")[1];
                var e_time = blocks[i].getAttribute('end_datetime').split(" ")[1];
                var times = parseInt(difHours(s_time, e_time).split(":")[0])/60;
                var not_oclock = s_time.split(":")[1];
                var hour=0;
                for (var j = 1; j < times ; ++j) {
                    hour = parseInt(blocks[i].getAttribute("start_hour")) + j;
                    $('#hour-' + hour).append('<li class="activity ' + blocks[i].getAttribute("is_speech") + blocks[i].getAttribute("activity_pk") + '" style="background-color:' + blocks[i].getAttribute("color") +'">' + '</li>');
                }
                if(not_oclock!=0)
                {
                    $('#hour-' + (hour+1)).append('<li class="activity ' + blocks[i].getAttribute("is_speech") + blocks[i].getAttribute("activity_pk") + '" style="background-color:' + blocks[i].getAttribute("color") +'">' + '</li>');
                }

                var element = {
                    'pk_speech': blocks[i].getAttribute("activity_pk"),
                    'color': blocks[i].getAttribute("color"),
                    'start_time': blocks[i].getAttribute("start_datetime"),
                    'end_time': blocks[i].getAttribute("end_datetime"),
                    'is_speech': blocks[i].getAttribute("is_speech"),
                    'room': blocks[i].getAttribute("room_pk"),
                    'description': blocks[i].getAttribute("desc"),
                }
                lista.push(element)
            }
            update_last_hours();
        });

        function delete_temp_activity(id, is_speech) {
            if (is_speech == 0) {
                is_speech = ""
            }
            for (var i = 0; i < lista.length; i++) {
                if (lista[i]['pk_speech'] == id && lista[i]['is_speech'] == is_speech) {
                    lista.splice(i, 1)
                }
            }
        }

        function delete_actity(room_pk, obj_pk) {
            $('#obj_pk').val(parseInt(obj_pk))
            $('#room_pk').val(parseInt(room_pk))
            $('#delete_activity').submit()

        }

        function activities_in_list(element) {
            value = false
            for (var i = 0; i < lista.length; i++) {
                if (lista[i]['is_speech'] === element['is_speech']) {
                    if (lista[i]['pk_speech'] == element['pk_speech']) {
                        lista.splice(i, 1)
                        lista.push(element)
                        value = true
                    }
                }
            }
            return value
        }

        function send_activities_list() {
            var token = '{{csrf_token}}';
            if (lista.length != 0) {
                $.ajax({
                    headers: {"X-CSRFToken": token},
                    type: "post",
                    data: {
                        'agenda': JSON.stringify(lista),
                    },
                    success: function (data) {
                        console.log(data)
                        location.reload()
                    }
                });
            } else {
                location.reload()
            }
        }

        function addhoras(hora, minutos) {
            starttime = new Date($("#actualDay").text() + " " + hora)
            starttime.setMinutes(starttime.getMinutes() + parseInt(minutos))
            endtime = $("#actualDay").text() + " " + starttime.getHours() + ":" + starttime.getMinutes() + ":00"
            return (endtime)
        }

        function addLastHour(hora, minutos) {
            starttime = new Date($("#actualDay").text() + " " + hora)
            starttime.setMinutes(starttime.getMinutes() + parseInt(minutos))
            endtime = ""+ starttime.getHours() + ":" + starttime.getMinutes() + ":00"
            return (endtime)
        }

        function substractLastHour(hora, minutos){
            starttime = new Date($("#actualDay").text() + " " + hora)
            starttime.setMinutes(starttime.getMinutes() - parseInt(minutos))
            endtime = ""+ starttime.getHours() + ":" + starttime.getMinutes() + ":00"
            return(endtime)
        }

        function send_filter() {
            $('#speeches').empty()
            $.ajax({
                url: "proposal/filterSpeeches/",
                type: "post",
                data: $("#filter").serialize(),
                success: function (data) {
                    if (data.result.length != 0) {
                        result = JSON.parse(data.result)
                        if (Object.entries(result).length == 0) {
                            result = null
                        }
                    } else {
                        result = null
                    }
                    if (result != null) {
                        for (var i = 0; i < result.length; i++)
                            $('#speeches').append('<li class="ui-state-default activity" style="background-color:' + data.color[i] + ';"' +
                                'value="' + Object.values(result[i])[1] + '" color="' + data.color[i] +
                                '" is_speech="1"' + 'desc="none"' + 'time="' + data.times[i] + '">' +
                                Object.values(result[i]['fields'])[2] + '</li>')
                        $('.draggable').draggable();
                    } else {
                        $('#speeches').append('<p>{% trans 'No results matched' %}</p>')
                    }
                }
            });
        }

        $(function displayOrEdit(){
            var action = '{{ view }}'
            if(action=='display'){
                $("#filterPanel").remove();
                $("#send_activities").remove();
                $(".deleteButton").remove();
                $("#addroom").remove();
                $('.activity').draggable({ disabled: true });
                $('.connectedSortable').sortable({ disabled: true });

            }
        });
    </script>
{% endblock %}